# Specification: Whisper & Transformers.js Strict Lazy Loading

## 1. Overview
現状、`Transformers.js` および `WhisperTranscription` クラスが初期ロード時に静的にインポートされており、ユーザーが拡張文字起こし機能を使用しない場合でも不要なリソースを消費している。本トラックでは、これらを完全に動的インポート化し、アプリの初期起動パフォーマンス（FCP/LCP）を向上させるとともに、読み込み時のUXを強化する。

## 2. Functional Requirements
- **厳密な遅延読み込みの実装:**
  - `main.ts` および `transcription-integration.ts` から `WhisperTranscription` の静的インポートを削除し、`import()` による動的インポートへ移行する。
  - ユーザーが「拡張文字起こし」を有効にしたタイミングで初めてライブラリをロードする。
- **設定UIの拡張:**
  - 設定画面に「パフォーマンス（または高度な設定）」セクションを新設する。
  - 「バックグラウンド事前ロード」のトグルスイッチを追加する（デフォルト：OFF）。
- **ユーザー体験（UX）の向上:**
  - ライブラリのロード中、UI（スイッチ部分など）にスピナーや「処理中」の状態を表示する。
  - ロード失敗時（ネットワークエラー等）のトースト通知またはダイアログによるエラー表示を実装する。
  - 初回ロード時に「ライブラリ（約XX MB）のロードに時間がかかる場合があります」というヒントを表示する。
- **バックグラウンド制御:**
  - 「バックグラウンド事前ロード」がONの場合、アプリ起動後のアイドル時間を利用してライブラリを事前に読み込む。

## 3. Non-Functional Requirements
- **バンドルサイズの削減:** メインバンドルから `Transformers.js` 関連コードを分離し、初期ロード時のJSサイズを削減する。
- **パフォーマンス:** 初期ページロード速度の向上。

## 4. Acceptance Criteria
- [ ] 初期ロード時、ブラウザのネットワークタブで `@huggingface/transformers` 関連のJSが読み込まれていないこと。
- [ ] 「拡張文字起こし」をONにした際、初めて関連JSが読み込まれ、ロード中を示すUIが表示されること。
- [ ] 設定画面の「パフォーマンス」セクションから事前ロードのON/OFFが切り替えられること。
- [ ] ネットワーク切断時にロードを試みた際、適切なエラーメッセージが表示されること。
- [ ] ロード完了後、拡張文字起こし機能が正常に動作すること。

## 5. Out of Scope
- Whisperモデルデータ（ONNX/WASMファイル）のキャッシュ戦略の変更（現状のTransformers.jsの仕組みを維持）。
- WebLLM（`web-llm`）側の遅延読み込みの実装（本トラックではWhisper/Transformers.jsに集中する）。
